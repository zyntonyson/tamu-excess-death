---
title: "Estimacion exceso de muertes (México)"
subtitle: Actualizacion Mayo 2021
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---


```{r message= FALSE, warning=FALSE}
library(tidyverse)
library(surveillance)
library(lubridate)
library(glue)
library(magrittr)
library(reshape2)

```


```{r}
iso_week<-function(anio,mes,dia)
{
  tryCatch(
    expr=week(glue('{anio}-{mes}-{dia}')),
    error= function(e){return(0)} 
  )
  
}

replace_na_with_zeros<-function(x)
{
  ifelse(is.na(x),0,x)
  }
```



## Datos México

### Histórico 2013-2019

Finalmente para la estimaciones de Farrington y canal endémico se usan desde el periodo 2015-2019. 

**Fuente de datos** [Base de datos de mortalidad por fecha y ocurrencia por INEGI](https://www.inegi.org.mx/programas/mortalidad/#Datos_abiertos)

```{r message= FALSE, warning=FALSE}
start_time <- Sys.time()

#Cargado de datos historicos (el conjunto de datos MX incluye 2012-2019)
df<-data.frame()
PATH=r"(E:\TAMUMXGEO\Mortalidad\data\Defunciones\data)"
for( file in list.files(PATH))
{
 test<-read_csv(glue(r"({PATH}\{file})"),) %>% select(ent_regis,dia_regis,mes_regis,anio_regis) %>%
  filter(dia_regis<=31,mes_regis<=12) %>% 
  mutate(week_regis=iso_week(anio_regis,mes_regis,dia_regis),
         ent_regis=as.numeric(ent_regis)) %>% 
  filter(week_regis>0, 
         ent_regis<=32,
         week_regis<=52
         ) %>% 
  group_by(anio_regis,
           week_regis,
           ent_regis) %>% 
  summarise(count=n())
 
 df<- rbind(df,test)
}

# Crear agregado nacional  ent_regis = 0
  test<-df %>% 
  group_by(anio_regis,week_regis) %>% 
  summarise(count=sum(count)) %>% 
  transmute(anio_regis=anio_regis,week_regis=week_regis,ent_regis=0,count=count)
  df<- rbind(df,test)

Sys.time()- start_time

```

**Salidas prueba**


```{r}
glue(" Rows:{nrow(df)}")
head(df,20)
```





## Estimacion de canal endémico

Calculo de cuantiles 25,50,75,90. El cuantil 90 es el consideramos como valor esperado.



```{r}
start_time <- Sys.time()

canal_endemico<- df %>%
  filter(anio_regis>=2015) %>% 
  group_by(ent_regis,week_regis) %>% 
  summarise(q25=quantile(count,0.25),
            q50=quantile(count,0.5),
            q75=quantile(count,0.75),
            q90=quantile(count,0.9)
            )



Sys.time()- start_time
```


**Salidas prueba**


```{r}
glue(" Rows:{nrow(canal_endemico)}")
head(canal_endemico,20)
```


# Estimación Farrington

## Anexar observaciones 2020


```{r}
start_time <- Sys.time()

# Lectura datos 2020
PATH=r'(G:\Mi unidad\TAMUMX\TAMUMXGEO\Mortalidad\data\Exceso_Mortalidad_MX_2020_2021_Historico\DDAAxsom2021SE12.csv)'
test <- read_csv(PATH) %>% 
  transmute(anio_regis=year(ymd(FECHA_DEFUNCION)),week_regis=week(ymd(FECHA_DEFUNCION)),ent_regis=as.numeric(ENTIDAD_REG)) %>% 
  filter(ent_regis<=32,week_regis<=52) %>% 
  group_by(anio_regis,week_regis,ent_regis) %>% 
  summarise(count=n()) 


# Agregar datos nacionales
national<- test %>% 
  group_by(anio_regis,week_regis) %>% 
  summarise(count=sum(count)) %>% 
  transmute(anio_regis=anio_regis,week_regis=week_regis,ent_regis=0,count=count)

df<-rbind(df,test,national)

Sys.time() - start_time

```



```{r}
glue(" Rows:{nrow(df)}")
head(df,20)
```





## Estimaciones Farrington por estado


```{r}
start_time <- Sys.time()


farrington_df<-data.frame()
id_est_unique<-unique(df$ent_regis)
for(id_est in id_est_unique)
{

# Slice por estado tomando hasta 2020
tmp<- df %>% 
      filter(ent_regis==id_est, anio_regis<2021) %>%
      mutate(state=0) %>% 
      arrange(anio_regis,week_regis)
    
# DisProg Object
DisProg<-create.disProg(week = 1:nrow(tmp),
                                  observed = tmp$count,
                                  state= tmp$state,
                                  start = c(2013,1))

# Predicciones para las 52 semanas finales
n<-length(DisProg$observed)
control <- list(b=4,
                w=3,
                range=(n-51):n,
                reweight=TRUE, 
                verbose=FALSE,
                alpha=0.05)
results<-algo.farrington(DisProg,control = control)

farrington_df<-rbind(farrington_df,
                     data.frame(week_regis=1:length(results$upperbound),
                                ent_regis=id_est,
                                estimated=results$upperbound))

}


Sys.time() - start_time
```


```{r}
glue(" Rows:{nrow(farrington_df)}")
head(farrington_df,20)
```





## Defunciones por COVID

```{r}
start_time <- Sys.time()
# Incluye nacional con id = 0

PATH=r'(G:\Mi unidad\TAMUMX\TAMUMXGEO\Mortalidad\data\2020\Casos_Diarios_Estado_Nacional_Defunciones_20210524.csv)'
defunciones_covid<- read_csv(PATH) %>% 
                    pivot_longer(.,cols=!c(1:3),names_to='date',values_to='deaths') %>% 
  mutate(week_regis=week(dmy(date)),anio_regis=year(dmy(date))) %>% 
  rename(ent_regis=cve_ent) %>% 
  group_by(anio_regis,week_regis,ent_regis) %>% 
  summarise(covid_deaths=sum(deaths))
Sys.time() - start_time

```



```{r}
glue(" Rows:{nrow(defunciones_covid)}")
head(defunciones_covid,20)
```




## Integración de datos

```{r}
start_time <- Sys.time()
  df %>% 
  filter(anio_regis %in% c(2020,2021)) %>% 
  rename(observed_deaths=count) %>% 
  left_join(canal_endemico,by=c('ent_regis','week_regis')) %>% 
  left_join(farrington_df,by=c('ent_regis','week_regis')) %>% 
  rename(farrington_est=estimated) %>% 
  left_join(defunciones_covid,by=c('anio_regis','ent_regis','week_regis')) %>% 
  mutate(covid_deaths=replace_na_with_zeros(covid_deaths)) %>% 
  write.csv(x=.,file=r"(G:\Mi unidad\TAMUMX\TAMUMXGEO\Mortalidad\dataMXExcess.csv)",row.names = FALSE)
  
Sys.time() - start_time

```

```{r}
  df %>% 
  filter(anio_regis %in% c(2020,2021)) %>% 
  rename(observed_deaths=count) %>% 
  left_join(canal_endemico,by=c('ent_regis','week_regis')) %>% 
  left_join(farrington_df,by=c('ent_regis','week_regis')) %>% 
  rename(farrington_est=estimated) %>% 
  left_join(defunciones_covid,by=c('anio_regis','ent_regis','week_regis')) %>% 
  mutate(covid_deaths=replace_na_with_zeros(covid_deaths)) %>% head(20)
```




## Datos para pruebas de visualización


```{r eval=FALSE}
start_time <- Sys.time()

PATH=r'(G:\Mi unidad\TAMUMX\TAMUMXGEO\Mortalidad\data\2020\Casos_Diarios_Estado_Nacional_Defunciones_20210524.csv)'
metadata<- read_csv(PATH) %>% 
  select(cve_ent,poblacion,nombre) %>%
  rename(ent_regis=cve_ent) %>% 
  distinct()


df %>% 
  filter(anio_regis %in% c(2020,2021)) %>% 
  rename(observed_deaths=count) %>% 
  left_join(canal_endemico,by=c('ent_regis','week_regis')) %>% 
  left_join(farrington_df,by=c('ent_regis','week_regis')) %>% 
  rename(farrington_est=estimated) %>% 
  left_join(defunciones_covid,by=c('anio_regis','ent_regis','week_regis')) %>% 
  mutate(covid_deaths=replace_na_with_zeros(covid_deaths)) %>%
  left_join(metadata,by='ent_regis') %>%
  write.csv(x=.,file=r"(G:\Mi unidad\TAMUMX\TAMUMXGEO\Mortalidad\dataMXExcess_shinny.csv)",row.names = FALSE)

Sys.time() - start_time
```




## Datos muertes 2020-2021
https://www.gob.mx/salud/documentos/datos-abiertos-152127


## Datos históricos mortalidad
https://www.gob.mx/cms/uploads/attachment/file/634705/Datos_abiertos_historicos_2021.pdf

## Muertes semanales covid

https://datos.covid-19.conacyt.mx/#DownZCSV
